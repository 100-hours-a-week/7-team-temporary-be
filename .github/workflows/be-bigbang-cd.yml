name: BigBang-BE-CD
on:
  push:
    branches:
      - 'release/**'
      - 'main'

jobs:
  build:
    name: Build Artifact (BE)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 25

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Build (Spring Boot)
        shell: bash
        run: |
          set -euo pipefail
          ./gradlew clean build -x spotlessJava --no-daemon

      - name: Package artifact
        shell: bash
        run: |
          set -euo pipefail
          JAR_PATH=$(ls -1 build/libs/*.jar 2>/dev/null | head -n 1)
          if [ -z "${JAR_PATH}" ]; then
            echo "Build output jar not found under build/libs"; exit 1;
          fi
          mkdir -p release_bundle
          cp "${JAR_PATH}" release_bundle/app.jar
          tar -czf app.tar.gz -C release_bundle .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: be-app-build
          path: app.tar.gz
          retention-days: 3

  deploy-staging:
    name: Deploy to BE Staging (develop -> release)
    runs-on: ubuntu-latest
    needs: build

    # PR merge 완료 된것들 (base가 release, head가 develop)
    if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/heads/release/') }}
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: be-app-build
          path: .

      - name: Upload artifact to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST_STAGING }}
          username: ${{ secrets.USER_STAGING }}
          key: ${{ secrets.SSH_KEY_STAGING }}
          port: ${{ secrets.PORT }}
          source: app.tar.gz
          target: /tmp

      - name: Deploy via SSH (staging)
        uses: appleboy/ssh-action@1.2.3
        with:
          host: ${{ secrets.HOST_STAGING }}
          username: ${{ secrets.USER_STAGING }}
          key: ${{ secrets.SSH_KEY_STAGING }}
          port: ${{ secrets.PORT }}
          script_stop: true
          script: |
            set -euo pipefail

            APP_DIR="${{ secrets.APP_DIR }}"
            PM2_NAME="${{ secrets.PM2_NAME }}"
            PORT="${{ secrets.PORT }}"

            RELEASE_ROOT="${APP_DIR}/releases"
            CURRENT_LINK="${APP_DIR}/current"
            NEXT_RELEASE="${RELEASE_ROOT}/$(date +%Y%m%d%H%M%S)"

            mkdir -p "${RELEASE_ROOT}" "${NEXT_RELEASE}"

            # 아티팩트 압축 해제 (app.jar 포함)
            if [ ! -f /tmp/app.tar.gz ]; then
              echo "ERROR: /tmp/app.tar.gz not found"; exit 1;
            fi
            tar -xzf /tmp/app.tar.gz -C "${NEXT_RELEASE}"

            JAR_PATH="${NEXT_RELEASE}/app.jar"
            if [ ! -f "${JAR_PATH}" ]; then
              echo "ERROR: app.jar not found in release"; exit 1;
            fi

            # current 심볼릭 링크 업데이트
            ln -sfn "${NEXT_RELEASE}" "${CURRENT_LINK}"

            echo "== [STAGING] pm2 restart"
            if pm2 describe "${PM2_NAME}" >/dev/null 2>&1; then
              pm2 restart "${PM2_NAME}" --update-env
            else
              pm2 start "java" --name "${PM2_NAME}" -- \
                -jar "${JAR_PATH}" \
                --server.port="${PORT}" \
            fi

            # 오래된 릴리즈 정리 (최근 3개만 유지)
            ls -dt "${RELEASE_ROOT}"/* 2>/dev/null | tail -n +4 | xargs -r rm -rf || true